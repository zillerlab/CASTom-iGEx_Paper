##################
### initialize ###

# get cases, save endophenotype
sbatch --job-name=def define_subset_CADHARD.sh
# get hypothesis-driven endophenotypes
sbatch --job-name=extr extract_CAD_pheno.sh

##########################
### varying parameters ###
# changes in kNN parameter, all samples
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_tscore_corrPCs_GTEx_kNNpar_CAD.sh
# keep kNN = 20, bootstrap samples (50%)
sbatch --job-name=prepare_bootstrap prepare_bootstrap_Cases_CAD.sh
for i in {1..10} 
do 
sbatch --job-name=CL_Cases_rep${i} --array=1-5,7-11,15 PriLer_cluster_tscore_corrPCs_GTEx_BootstrapSamples50_CAD.sh $i
done

# change corr threshold
corr_thr=(0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1)
for i in ${corr_thr[@]} 
do 
sbatch --job-name=CL_Cases_thr${i} --array=1-5,7-11,15 PriLer_cluster_tscore_corrPCs_GTEx_corrthr_CAD.sh $i
done

#################
### benchmark ###
### cluster based on PCs (benchmark)###
sbatch --job-name=CL_Cases cluster_PCs_CAD.sh Cases 
sbatch --job-name=CL_Cases cluster_PCs_endophenotype_CAD.sh Cases 

### cluster zscaled tscores (benchmark) 
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_tscore_GTEx_CAD.sh 
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_endophenotype_tscore_GTEx_CAD.sh

### cluster Cases without zscaling, corr for PCs (benchmark) ###
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_tscore_corrPCs_original_GTEx_CAD.sh 
sbatch --job-name=CL_Cases --array=11 PriLer_cluster_tscore_corrPCs_original_featureRelTscore_GTEx_CAD.sh 
sbatch --job-name=CL_Cases --array=11 PriLer_cluster_tscore_corrPCs_original_featureRelPath_GTEx_CAD.sh
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_endophenotype_tscore_corrPCs_original_GTEx_CAD.sh

#########################################
### cluster removing PCs from tscores ###
sbatch --job-name=filt --array=1-5,7-11,15 filter_pathway_JS.sh # filter pathway to associate with clustering structure
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_tscore_corrPCs_GTEx_CAD.sh 
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_endophenotype_tscore_corrPCs_GTEx_CAD.sh # hypothesis free: UKBB phenotypes 
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_endophenotype_nominal_tscore_corrPCs_GTEx_CAD.sh # hypothesis-driven
sbatch --job-name=CL_Cases --array=1-5,7-11,15 PriLer_cluster_treatmentResponse_tscore_corrPCs_GTEx_CAD.sh # treatment response 

## focus on Liver cluster ##
sbatch --job-name=CL_Cases --array=11,15 PriLer_cluster_tscore_corrPCs_featureRelTscore_GTEx_CAD.sh 
sbatch --job-name=CL_Cases --array=11,15 PriLer_cluster_tscore_corrPCs_featureRelPath_GTEx_CAD.sh
sbatch --job-name=CL_Cases --array=11,15 PriLer_cluster_tscore_corrPCs_pathSEA_GTEx_CAD.sh 
# check treatment response
Rscript get_common_treatments_pathSEA_liverCL.R
f=/psycl/g/mpsziller/lucia/CAD_UKBB/eQTL_PROJECT/INPUT_DATA_GTEx/CAD/Covariates/UKBB/CAD_HARD_clustering/pathSEA/
awk -F '\t' 'NR>1{print $8}' ${f}phenotypeDescription_Covariates_tot.txt > ${f}treatment_names
sbatch --job-name=CL_Cases --array=1-19 PriLer_cluster_treatmentResponse_pathSEAhits_tscore_corrPCs_GTEx_CAD.sh

########################
## compare benchmarks ##
########################
sbatch compare_PC_zscaledcorr_zscaled.sh

#############################################
## predict on external cohort (only Liver) ##
#############################################

# predict clustering (needed all cluster to evaluate risk score)
for c in ${name_c[@]}
do
sbatch --job-name=CL_Cases_${c} --array=1-5,7-11,15%2 PriLer_cluster_tscore_corrPCs_predict_GTEx_CAD.sh ${c}
done
# find associated genes
for c in ${name_c[@]}
do
sbatch --job-name=CL_Cases_${c} --array=11 PriLer_predict_cluster_tscore_corrPCs_featureRelTscore_GTEx_CAD.sh ${c}
done
# evaluate (phenotype, percentage, corrlation, loci)
sbatch --job-name=CL_Cases --array=11 PriLer_cluster_predictEval_tscore_corrPCs_GTEx_CAD.sh

#######################
## gene-RS benchmark ##
#######################
sbatch --job-name=rs_CAD --array=1,3-4,7,9-11,15 risk_score_clusterCAD_tscore_corrPCs.sh 100
sbatch --job-name=rs_CAD --array=2,5,8 risk_score_clusterCAD_tscore_corrPCs.sh 99
sbatch --job-name=rs_ev_CAD --array=1-5,7-11,15 evaluate_risk_score_CADrel_tscore_corrPCs.sh # r2 for riskscore - phenotype association
sbatch --job-name=pl_rs_ev plot_evaluate_risk_score_corrPCs.sh 
sbatch --job-name=cl_rs_CAD --array=1-5,7-11,15 risk_score_clusterCAD_tscore_corrPCs_cluster_endophenotype.sh
sbatch --job-name=compare_gr --array=1-5,7-11,15 compare_endophenotypeAnalysis_clusterRiskScore_CAD.sh
sbatch --job-name=pl_rs_gr plot_precision_risk_score_clusterCases.sh 

# build RS on Cardiogam
name_c=(German1 German2 German3 German4 German5 CG WTCCC LURIC MG)
for c in ${name_c[@]}
do
sbatch --job-name=${c} --array=1-5,7-11,15%2 risk_score_clusterCAD_tscore_corrPCs_externalCohorts.sh ${c} 
done

# meta analysis
sbatch --job-name=rs_predict --array=1-5,7-11,15 risk_score_clusterCAD_tscore_corrPCs_externalCohorts_endophenotype_metaAnalysis.sh 
sbatch --job-name=rs_predict --array=1-5,7-11,15 compare_endophenotypeAnalysis_clusterRiskScore_externalCohorts_CAD.sh
sbatch --job-name=plot_rs_predict plot_precision_risk_score_clusterCases_externalCohorts.sh 

###################
#### bechmark #####
# what if the pipeline is applied on non-affected individuals? #
# cluster Controls without zscaling, corr for PCs (benchmark)
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_tscore_corrPCs_original_GTEx_CAD.sh 
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_endophenotype_tscore_corrPCs_original_GTEx_CAD.sh
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_endophenotype_nominal_tscore_corrPCs_original_GTEx_CAD.sh 
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_tscore_corrPCs_original_featureRelTscore_GTEx_CAD.sh
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_tscore_corrPCs_original_featureRelPath_GTEx_CAD.sh
# cluster Controls with zscaling, corr for PCs (benchmark)
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_tscore_corrPCs_GTEx_CAD.sh 
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_endophenotype_tscore_corrPCs_GTEx_CAD.sh
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_endophenotype_nominal_tscore_corrPCs_GTEx_CAD.sh 
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_tscore_corrPCs_featureRelTscore_GTEx_CAD.sh
sbatch --job-name=CL_Controls --array=11 PriLer_clusterControls_tscore_corrPCs_featureRelPath_GTEx_CAD.sh

###################
#### bechmark #####
# comparison of clustering strategy based on PRS. Can we explain more variance in the endophenotype from out groupings?
sbatch --job-name=prepare prepare_PRS_cl.sh
# associate with endophenotypes
sbatch --job-name=deciles PriLer_clusterCases_endophenotype_PRS_GTEx_CAD.sh deciles
sbatch --job-name=quantiles PriLer_clusterCases_endophenotype_PRS_GTEx_CAD.sh quantiles
# get genes and pathways
sbatch --job-name=deciles PriLer_clusterCases_PRS_featureRelTscore_GTEx_CAD.sh deciles
sbatch --job-name=quantiles PriLer_clusterCases_PRS_featureRelTscore_GTEx_CAD.sh quantiles
sbatch --job-name=deciles PriLer_clusterCases_PRS_featureRelPath_GTEx_CAD.sh deciles
sbatch --job-name=quantiles PriLer_clusterCases_PRS_featureRelPath_GTEx_CAD.sh quantiles

# correct endophenotype results based on those associated with CAD related pathways from PALAS
# correct all the analysis: cases, controls and PRS
sbatch --job-name=filt Endo_CAD_v2.sh

# compute F-statistics and R2
sbatch --job-name=R2_deciles PriLer_clusterCases_R2_endopheno_from_PRS.sh deciles
sbatch --job-name=R2_quantiles PriLer_clusterCases_R2_endopheno_from_PRS.sh quantiles
sbatch --job-name=R2_tissue --array=11 PriLer_clusterCases_R2_endopheno_from_group.sh

################################
#### cluster-specific PALAS ####
# create cluster-specific phenotypes (set NA to other groups)
sbatch --job-name=preproc --array=11 prepare_cluster_specific_pheno.sh

# run associations
index_tissues=(1 2 3 4 5 7 8 9 10 11 15)
for i in ${index_tissues[@]}
do
# fix cluster in Liver
sbatch --job-name=t${i}_clt11 --array=1-100 PriLer_phenoAssociation_tscore_clusterCasesVSControls.sh ${i} 11
sbatch --job-name=t${i}_clt11 --array=1-100 PriLer_phenoAssociation_pathR_clusterCasesVSControls.sh ${i} 11
sbatch --job-name=t${i}_clt11 --array=1-100 PriLer_phenoAssociation_pathGO_clusterCasesVSControls.sh ${i} 11
sbatch --job-name=t${i}_clt11_wiki PriLer_phenoAssociation_wikiPath_clusterCasesVSControls.sh ${i} 11
done

# combine
for i in ${index_tissues[@]}
do
sbatch --job-name=comb_clt11 --array=${i} PriLer_phenoAssociation_combine_clusterCasesVSControls.sh 11
sbatch --job-name=comb_clt11_wiki --array=${i} PriLer_phenoAssociation_combine_wikiPath_clusterCasesVSControls.sh 11
done
### combine all results
Rscript ./create_txt_allTissues_cl11_CAD_UKBB.R
