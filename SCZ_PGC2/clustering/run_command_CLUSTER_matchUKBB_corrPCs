### cluster all Cases ###
# use only genes that have same expression in UKBB and SCZ (to be used for comparison)
# run another version with filtered genes based on expression
# remove boco cohort (German), 

## before detect outliers across all tissues ##
readarray -t name_cohorts < /home/luciat/eQTL_PROJECT/INPUT_DATA/SCZ_cohort_names_CLUST
readarray -t tissues < /home/luciat/eQTL_PROJECT/OUTPUT_GTEx/Tissue_PGCgwas_red

# CMC #

for c in ${name_cohorts[@]}
do
echo $c
cp /archive/luciat/eQTL_PROJECT/OUTPUT_CMC/predict_PGC/200kb/${c}/devgeno0.01_testdevgeno0/predictedTscores.txt /home/luciat/eQTL_PROJECT/OUTPUT_CMC/predict_PGC/200kb/${c}/devgeno0.01_testdevgeno0/
done
cp /archive/luciat/eQTL_PROJECT/OUTPUT_CMC/train_CMC/200kb/resPrior_regEval_allchr.txt /home/luciat/eQTL_PROJECT/OUTPUT_CMC/train_CMC/200kb/

sbatch --job-name=outDect outliersDet_tscore_corrPCs_Cases_CMC_matchUKBB.sh
sbatch --job-name=outDect_filt outliersDet_tscore_corrPCs_Cases_filt_CMC_matchUKBB.sh

# GTEx #
for id_t in $(seq 1 1 9)
do
t=$(eval echo "\${tissues[${id_t}-1]}")

echo $t
for c in ${name_cohorts[@]}
do
common_part=luciat/eQTL_PROJECT/OUTPUT_GTEx/predict_PGC/${t}/200kb/PGC_GWAS_bin1e-2/${c}/devgeno0.01_testdevgeno0/
cp /archive/${common_part}/predictedTscores.txt /home/${common_part}/
done
cp /archive/luciat/eQTL_PROJECT/OUTPUT_GTEx/train_GTEx/${t}/200kb/PGC_GWAS_bin1e-2/resPrior_regEval_allchr.txt /home/luciat/eQTL_PROJECT/OUTPUT_GTEx/train_GTEx/${t}/200kb/PGC_GWAS_bin1e-2/
done

sbatch --job-name=outDect --array=1-9 outliersDet_tscore_corrPCs_Cases_GTEx_matchUKBB.sh
sbatch --job-name=outDect_noMHC --array=1-9 outliersDet_tscore_corrPCs_Cases_filt_GTEx_matchUKBB.sh


#####
# create a new file with total samples to exclude
sbatch --job-name=comb combine_outliers_tscore_corrPCs_cluster_matchUKBB.sh

######################################
### cluster each tissue seperately ###
######################################
### CMC ###

sbatch --job-name=CL_Cases PriLer_cluster_tscore_corrPCs_CMC_matchUKBB.sh
sbatch --job-name=CL_Cases_filt0.1 PriLer_cluster_tscore_corrPCs_filt_CMC_matchUKBB.sh

### GTEx ###
sbatch --job-name=CL_Cases --array=1-9 PriLer_cluster_tscore_corrPCs_GTEx_matchUKBB.sh
sbatch --job-name=CL_Cases_filt0.1 --array=1-9 PriLer_cluster_tscore_corrPCs_filt_GTEx_matchUKBB.sh

## move big result on the archive
for id_t in $(seq 1 1 9)
do
t=$(eval echo "\${tissues[${id_t}-1]}")

echo $t
common_part=luciat/eQTL_PROJECT/OUTPUT_GTEx/predict_PGC/${t}/200kb/PGC_GWAS_bin1e-2/Meta_Analysis_SCZ/devgeno0.01_testdevgeno0/update_corrPCs/

mkdir -p /archive/${common_part}/

mv /home/${common_part}/matchUKBB_tscore_corrPCs_zscaled_clusterCases_PGmethod_HKmetric.RData /archive/${common_part}/
mv /home/${common_part}/matchUKBB_filt0.1_tscore_corrPCs_zscaled_clusterCases_PGmethod_HKmetric.RData /archive/${common_part}/

done

#######################################
### find relevant features (Tscore) ###
#######################################
### CMC ###
sbatch --job-name=CL_Cases PriLer_cluster_CMC_tscore_corrPCs_featureRelTscore_matchUKBB.sh
sbatch --job-name=CL_Cases_filt0.1 PriLer_cluster_CMC_tscore_corrPCs_featureRelTscore_filt_matchUKBB.sh

########################################
### find relevant features (Pathway) ###
########################################
# get pathway scores

for c in ${name_cohorts[@]}
do
echo $c
common_part=luciat/eQTL_PROJECT/OUTPUT_CMC/predict_PGC/200kb/${c}/devgeno0.01_testdevgeno0/
cp /archive/${common_part}/Pathway_Reactome_scores.txt /home/${common_part}/
cp /archive/${common_part}/Pathway_GO_scores.txt /home/${common_part}/
done


for id_t in $(seq 1 1 9)
do
t=$(eval echo "\${tissues[${id_t}-1]}")
echo $t
for c in ${name_cohorts[@]}
do
echo $c
common_part=luciat/eQTL_PROJECT/OUTPUT_GTEx/predict_PGC/${t}/200kb/PGC_GWAS_bin1e-2/${c}/devgeno0.01_testdevgeno0/
cp /archive/${common_part}/Pathway_Reactome_scores.txt /home/${common_part}/
cp /archive/${common_part}/Pathway_GO_scores.txt /home/${common_part}/
done
done

# get jaccard similarity values
sbatch --job-name=js --array=1-9 filter_pathway_JS_GTEx.sh
sbatch --job-name=js filter_pathway_JS_CMC.sh

### CMC ###
sbatch --job-name=CL_Cases PriLer_cluster_CMC_tscore_corrPCs_featureRelPath_matchUKBB.sh
sbatch --job-name=CL_Cases_filt0.1 PriLer_cluster_CMC_tscore_corrPCs_featureRelPath_filt_matchUKBB.sh

###################################
### predict on external dataset ###
###################################
### CMC ###
c=scz_boco_eur

common_part=luciat/eQTL_PROJECT/OUTPUT_CMC/predict_PGC/200kb/${c}/devgeno0.01_testdevgeno0/
cp /archive/${common_part}predictedTscores.txt /home/${common_part}

for id_t in $(seq 1 1 9)
do
t=$(eval echo "\${tissues[${id_t}-1]}")
echo $t
common_part=luciat/eQTL_PROJECT/OUTPUT_GTEx/predict_PGC/${t}/200kb/PGC_GWAS_bin1e-2/${c}/devgeno0.01_testdevgeno0/
cp /archive/${common_part}predictedTscores.txt /home/${common_part}
done

sbatch --job-name=boco_Cases PriLer_cluster_tscore_corrPCs_predict_CMC_matchUKBB.sh
sbatch --job-name=boco_Cases_filt0.1 PriLer_cluster_tscore_corrPCs_predict_filt_CMC_matchUKBB.sh

# find relevant genes
sbatch --job-name=boco_Cases PriLer_predict_CMC_tscore_corrPCs_featureRel_matchUKBB.sh
sbatch --job-name=boco_Cases_filt0.1 PriLer_predict_CMC_tscore_corrPCs_featureRel_filt_matchUKBB.sh

# evaluate clustering
sbatch --job-name=boco_Cases PriLer_cluster_predictEval_tscore_corrPCs_CMC_matchUKBB.sh
sbatch --job-name=boco_Cases_filt0.1 PriLer_cluster_predictEval_tscore_corrPCs_CMC_filt_matchUKBB.sh

##########
# remove pathway scores from home (already in archive)
for t in ${tissues[@]}
do
for c in ${name_cohorts[@]}
do
rm /home/luciat/eQTL_PROJECT/OUTPUT_GTEx/predict_PGC/${t}/200kb/PGC_GWAS_bin1e-2/${c}/devgeno0.01_testdevgeno0/Pathway_Reactome_scores.txt
rm /home/luciat/eQTL_PROJECT/OUTPUT_GTEx/predict_PGC/${t}/200kb/PGC_GWAS_bin1e-2/${c}/devgeno0.01_testdevgeno0/Pathway_GO_scores.txt
done
done

###############################################################################################
### find differences in clustering structures for risk scores computed from UKBB phenotypes ###
###############################################################################################

#### compute risk scores ####
sbatch --job-name=CMC risk_score_tscore_corrPCs_multipleCohorts_CMC_matchUKBB.sh
sbatch --job-name=GTEx --array=1-9 risk_score_tscore_corrPCs_multipleCohorts_GTEx_matchUKBB.sh
# all samples (CMC only)
sbatch --job-name=CMC risk_score_tscore_corrPCs_allCohorts_allSamples_CMC_matchUKBB.sh

#### evaluate geneRS group differences (all together) ####
## CMC
sbatch --job-name=CMC risk_score_tscore_corrPCs_clusterSCZ_endophenotypeUKBB_CMC_matchUKBB.sh
sbatch --job-name=CMC_filt risk_score_tscore_corrPCs_clusterSCZ_endophenotypeUKBB_CMC_filt_matchUKBB.sh
# all samples (CMC only)
# ../RSCRIPT/addControls_to_clusterCases_corrPCs.R
sbatch --job-name=CMC risk_score_tscore_corrPCs_clusterSCZaddControls_endophenotypeUKBB_CMC_matchUKBB.sh

## GTEx
sbatch --job-name=GTEx --array=1-9 risk_score_tscore_corrPCs_clusterSCZ_endophenotypeUKBB_GTEx_matchUKBB.sh
sbatch --job-name=GTEx_filt --array=1-9 risk_score_tscore_corrPCs_clusterSCZ_endophenotypeUKBB_GTEx_filt_matchUKBB.sh

#################################
### cluster based on PCs:1-20 ###
#################################

../RSCRIPT/preProcess_PCs_clustering.R
sbatch --job-name=CL_Cases PriLer_cluster_PCs_matchUKBB.sh

# find geneRS differences built on CMC
sbatch --job-name=CMC risk_score_tscore_corrPCs_clusterSCZ_PCs_endophenotypeUKBB_CMC_matchUKBB.sh

## plot DLPC clustering and PCs and cohort actual distribution
plot_PCs_cohort_cluster.R

## plot MHC clustering genes diff (heatmap) and spider plots
## can only be run on LISA cluster as data cannot be moved!
plot_SCZclustering_DLPC_LISA.R
